name: Pyodide Test

on:
  workflow_call:
    inputs:
      build-artifact-name:
        required: true
        type: string
      build-artifact-path:
        required: true
        type: string
      pyodide-version:
        required: false
        type: string
        default: "0.27.2"
      os:
        required: false
        type: string
        default: "ubuntu-latest"
      runner:
        required: false
        type: string
        default: "selenium"
      browser:
        required: false
        type: string
        default: "chrome"
      browser-version:
        required: false
        type: string
        default: "latest"
      playwright-version:
        required: false
        type: string
        default: "" # latest
      pytest-extra-args:
        required: false
        type: string
        default: ""
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}-${{ inputs.os }}-${{ inputs.runner }}-${{ inputs.browser }}-${{ inputs.browser-version }}-${{ inputs.pyodide-version }}-${{ inputs.playwright-version }}
  cancel-in-progress: true

jobs:
  test:
    name: test (${{ inputs.pyodide-version}},${{ inputs.browser }},${{ inputs.runner }})
    runs-on: ${{ inputs.os }}
    env:
      DISPLAY: :99
      FORCE_COLOR: 3
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install node
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        if: ${{ contains(inputs.browser, 'node') || inputs.runner == 'playwright' }}
        with:
          node-version: ${{ inputs.browser-version }}

      - name: Cache Playwright browsers
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        if: ${{ inputs.runner == 'playwright' }}
        with:
          path: .cache/ms-playwright
          key: ${{ runner.os }}-playwright-latest

      - name: Install playwright
        if: ${{ inputs.runner == 'playwright' }}
        run: |
          if [ -n "${{ inputs.playwright-version }}" ]
          then
            python -m pip install playwright==${{inputs.playwright-version}}
          else
            python -m pip install playwright
          fi
          # TODO: install only browsers that are required
          python -m playwright install --with-deps

      - uses: pyodide/pyodide-actions/download-pyodide@012fa537869d343726d01863a34b773fc4d96a14 # v2
        with:
          version: ${{ inputs.pyodide-version }}
          to: pyodide-dist

      - uses: pyodide/pyodide-actions/install-browser@012fa537869d343726d01863a34b773fc4d96a14 # v2
        with:
          runner: ${{ inputs.runner }}
          browser: ${{ inputs.browser }}
          browser-version: ${{ inputs.browser-version }}
          playwright-version: ${{ inputs.playwright-version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifacts from calling package
        if: ${{ inputs.build-artifact-name != 'none' }}
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ inputs.build-artifact-name }}
          path: ${{ inputs.build-artifact-path }}
          merge-multiple: true

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: 3.12

      - name: install pyodide-py
        run: |
          python -m pip install pyodide-py==${{inputs.pyodide-version}}

      - name: Install pytest-pyodide
        run: |
          python -m pip install pytest-pyodide

      - name: Run tests
        run: |
          python -m pytest -vra \
            --dist-dir=./pyodide-dist/ \
            --runner=${{ inputs.runner }} \
            --rt=${{ inputs.browser }} \
            ${{ inputs.pytest-extra-args }} \
            tests/pyodide
